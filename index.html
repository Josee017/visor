<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberNexus | Secure Vault</title>
    <!-- Fuentes Futuristas -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Default Dark Mode (Cyberpunk Night) */
            --primary-color: #00f3ff;
            --primary-glow: rgba(0, 243, 255, 0.4);
            --bg-dark: #050508;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: 16px;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --danger: #ff2a6d;
            --success: #05ffa1;
            --warning: #ffcc00;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --transition-speed: 0.3s;
            --input-bg: rgba(0,0,0,0.3);
        }

        /* Light Mode Overrides (Laboratory Day) */
        body.light-mode {
            --bg-dark: #eef2f5;
            --text-main: #1f2937;
            --text-muted: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(255, 255, 255, 0.8);
            --primary-glow: rgba(0, 243, 255, 0.25);
        }

        /* Invert Particles for Light Mode */
        body.light-mode #particles-js {
            filter: invert(1) opacity(0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
            top: 0;
            left: 0;
            transition: filter 0.5s ease;
        }

        /* =========================================
           2. UI COMPONENTS & UTILITIES
           ========================================= */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            transition: backdrop-filter 0.2s, background 0.5s ease, border-color 0.5s ease;
        }

        .btn {
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 24px;
            font-family: var(--font-display);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .btn:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        
        .btn:disabled, .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
            border-color: var(--glass-border);
            color: var(--text-muted);
            box-shadow: none !important;
        }
        
        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(255, 42, 109, 0.05);
        }
        
        .btn-danger:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 15px rgba(255, 42, 109, 0.4);
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .btn-command {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            animation: pulse-glow 3s infinite;
        }

        .btn-command:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
            transform: rotate(90deg);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px var(--primary-glow); }
            50% { box-shadow: 0 0 15px var(--primary-glow), 0 0 5px var(--primary-color); }
            100% { box-shadow: 0 0 5px var(--primary-glow); }
        }
        
        .btn-float {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            z-index: 20;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s forwards; }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           2.5 NOTIFICATION SYSTEM
           ========================================= */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
        }

        .cyber-toast {
            pointer-events: auto;
            min-width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--toast-color);
            padding: 15px 20px;
            border-radius: 4px;
            color: var(--text-main);
            font-family: var(--font-body);
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 0 10px var(--toast-glow);
            animation: slideInRight 0.4s ease forwards;
            position: relative;
            overflow: hidden;
        }

        .cyber-toast.hide { animation: fadeOut 0.4s ease forwards; }

        .cyber-toast::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 100%;
            background: var(--toast-color);
            animation: timer 4s linear forwards;
        }

        .toast-icon { font-size: 1.5rem; color: var(--toast-color); }
        .toast-success { --toast-color: var(--success); --toast-glow: rgba(5, 255, 161, 0.3); }
        .toast-error { --toast-color: var(--danger); --toast-glow: rgba(255, 42, 109, 0.3); }
        .toast-info { --toast-color: var(--primary-color); --toast-glow: var(--primary-glow); }

        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(50%); opacity: 0; } }
        @keyframes timer { from { width: 100%; } to { width: 0%; } }

        /* =========================================
           3. AUTH MODULE STYLES
           ========================================= */
        #auth-container { width: 100%; max-width: 400px; padding: 40px; text-align: center; }
        .logo { font-family: var(--font-display); font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 0 10px var(--primary-glow); }
        .input-group { margin-bottom: 20px; text-align: left; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-icon-left { position: absolute; left: 12px; color: var(--text-muted); pointer-events: none; }
        .input-toggle-right { position: absolute; right: 12px; color: var(--text-muted); cursor: pointer; transition: color 0.3s; }
        .input-toggle-right:hover { color: var(--primary-color); }

        .cyber-input {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-bottom: 2px solid var(--text-muted);
            padding: 12px 12px 12px 40px;
            color: var(--text-main);
            font-family: var(--font-body);
            font-size: 1.1rem;
            transition: 0.3s;
        }
        .cyber-input:focus { border-bottom-color: var(--primary-color); box-shadow: 0 4px 10px -5px var(--primary-glow); }
        .cyber-input.error { border-color: var(--danger); border-bottom-color: var(--danger); box-shadow: 0 0 10px rgba(255, 42, 109, 0.3); color: var(--danger); }

        .strength-meter { height: 4px; background: #333; margin-top: 5px; width: 100%; position: relative; overflow: hidden; border-radius: 2px; }
        .strength-bar { height: 100%; width: 0%; transition: width 0.3s ease-out, background-color 0.3s ease; }
        .strength-text { font-size: 0.75rem; margin-top: 5px; text-align: right; min-height: 1rem; }
        .toggle-auth { margin-top: 20px; color: var(--text-muted); font-size: 0.9rem; cursor: pointer; }
        .toggle-auth span { color: var(--primary-color); }

        /* =========================================
           4. DASHBOARD STYLES
           ========================================= */
        #dashboard-container { width: 95vw; height: 90vh; display: grid; grid-template-columns: 1fr; grid-template-rows: 70px 1fr; gap: 20px; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.05); }
        .main-area { padding: 20px 40px; overflow-y: auto; position: relative; }

        .drop-zone { border: 2px dashed var(--glass-border); border-radius: 12px; height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; margin-bottom: 40px; position: relative; overflow: hidden; }
        .drop-zone.dragover { border-color: var(--primary-color); background: rgba(0, 243, 255, 0.05); box-shadow: inset 0 0 20px var(--primary-glow); }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); opacity: 0; z-index: 5; }
        .scanning .scan-line { opacity: 1; animation: scanAnim 1.5s infinite linear; }
        @keyframes scanAnim { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }

        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        .file-card { background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.3s; }
        .file-card:hover { border-color: var(--primary-color); transform: translateY(-5px); background: rgba(255,255,255,0.05); }
        .file-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .file-name { font-size: 0.9rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* =========================================
           5. MODALS
           ========================================= */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .editor-window { width: 90%; height: 90%; background: var(--bg-dark); border: 1px solid var(--primary-color); display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .small-modal { width: 100%; max-width: 450px; padding: 30px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .settings-modal { width: 100%; max-width: 600px; padding: 0; max-height: 85vh; overflow-y: auto; background: var(--bg-dark); }
        .settings-grid { display: grid; gap: 20px; padding: 30px; }
        .settings-section { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 20px; border-radius: 8px; }
        .settings-title { color: var(--primary-color); font-family: var(--font-display); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }

        .user-stats-header { display: flex; align-items: center; gap: 20px; margin-bottom: 10px; }
        .avatar-circle { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #333, #000); border: 2px solid var(--primary-color); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--primary-color); box-shadow: 0 0 15px var(--primary-glow); }
        .stats-info { flex: 1; }
        .storage-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .storage-bar-fill { height: 100%; width: 15%; background: var(--warning); box-shadow: 0 0 10px var(--warning); }

        .theme-cards-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .theme-card { height: 60px; border-radius: 8px; border: 1px solid var(--glass-border); cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s, border-color 0.2s; }
        .theme-card:hover { transform: scale(1.02); border-color: var(--text-main); }
        .theme-card.active { border: 2px solid var(--text-main); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .theme-label { position: absolute; bottom: 5px; left: 10px; font-size: 0.7rem; font-weight: bold; color: rgba(0,0,0,0.7); background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; }

        .range-container { margin-top: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 25px; display: block; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px var(--primary-glow); border: 2px solid #fff; position: relative; z-index: 2; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: rgba(255, 255, 255, 0.2); border-radius: 3px; border: 1px solid rgba(255, 255, 255, 0.1); }
        input[type=range]::-moz-range-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; box-shadow: 0 0 10px var(--primary-glow); border: 2px solid #fff; }
        input[type=range]::-moz-range-track { width: 100%; height: 6px; cursor: pointer; background: rgba(255, 255, 255, 0.2); border-radius: 3px; border: 1px solid rgba(255, 255, 255, 0.1); }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border: 1px solid var(--glass-border); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .chat-modal { width: 100%; max-width: 600px; height: 70vh; }
        
        .editor-header { background: rgba(255,255,255,0.05); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); }
        .editor-content { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, var(--primary-glow) 0%, transparent 70%); }
        
        /* FILENAME INPUT STYLES */
        .filename-wrapper { position: relative; display: inline-block; width: auto; }
        .filename-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-main);
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 500;
            padding: 5px 25px 5px 5px;
            width: 300px;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .filename-input:focus { border-bottom-color: var(--primary-color); background: rgba(255,255,255,0.05); outline: none; }
        .filename-wrapper::after { content: '‚úèÔ∏è'; position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; filter: grayscale(1) brightness(2); }
        .filename-wrapper:hover::after { opacity: 0.7; }

        #code-editor { width: 100%; height: 100%; background: rgba(0,0,0,0.1); color: var(--primary-color); font-family: 'Courier New', monospace; padding: 20px; border: none; resize: none; font-size: 14px; line-height: 1.5; }
        #pdf-viewer, #img-viewer, #video-viewer { width: 100%; height: 100%; border: none; object-fit: contain; }
        #img-viewer { max-width: 100%; max-height: 100%; padding: 20px; }
        video:focus, audio:focus { outline: none; }
        #audio-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .audio-visualizer { width: 80px; height: 80px; border-radius: 50%; background: var(--glass-bg); border: 2px solid var(--primary-color); display: flex; justify-content: center; align-items: center; font-size: 2rem; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 70% { box-shadow: 0 0 0 20px rgba(0, 243, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }
        .modal-title { margin-bottom: 20px; font-family: var(--font-display); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        
        .chat-history { flex: 1; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px; }
        .chat-msg { padding: 10px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; }
        .msg-user { align-self: flex-end; background: var(--primary-glow); border: 1px solid var(--primary-color); }
        .msg-ai { align-self: flex-start; background: var(--glass-bg); border: 1px solid var(--glass-border); }
        .ai-loading { align-self: flex-start; color: var(--text-muted); font-style: italic; }
    </style>
</head>
<body>

    <canvas id="particles-js"></canvas>
    <div id="toast-container"></div>

    <div id="auth-container" class="glass-panel fade-in">
        <h1 class="logo">CYBER<span style="color:var(--primary-color)">NEXUS</span></h1>
        
        <div id="login-form">
            <h3 style="margin-bottom:20px; font-weight:300;">IDENTIFICACI√ìN REQUERIDA</h3>
            <div class="input-group">
                <label>Correo de Acceso</label>
                <div class="input-wrapper">
                    <span class="input-icon-left">‚úâ</span>
                    <input type="email" id="login-email" class="cyber-input" placeholder="usuario@dominio.com">
                </div>
            </div>
            <div class="input-group">
                <label>Clave de Acceso</label>
                <div class="input-wrapper">
                    <span class="input-icon-left">üîí</span>
                    <input type="password" id="login-pass" class="cyber-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>
            <button class="btn" style="width:100%" onclick="app.auth.login()">Conectar</button>
            <div class="toggle-auth" onclick="app.auth.toggleView('register')">
                ¬øSin credenciales? <span>Solicitar Acceso</span>
            </div>
        </div>

        <div id="register-form" class="hidden">
            <h3 style="margin-bottom:20px; font-weight:300;">NUEVO REGISTRO</h3>
            <div class="input-group">
                <label>Correo Institucional</label>
                <div class="input-wrapper">
                    <span class="input-icon-left">‚úâ</span>
                    <input type="email" id="reg-email" class="cyber-input" placeholder="usuario@dominio.com">
                </div>
            </div>
            <div class="input-group">
                <label>Contrase√±a Maestra</label>
                <div class="input-wrapper">
                    <span class="input-icon-left">üîë</span>
                    <input type="password" id="reg-pass" class="cyber-input" onkeyup="app.auth.checkStrength(this.value)">
                </div>
                <div class="strength-meter"><div id="strength-bar" class="strength-bar"></div></div>
                <div id="strength-text" class="strength-text"></div>
            </div>
            <button id="btn-register" class="btn" style="width:100%" onclick="app.auth.register()" disabled>Inicializar Protocolo</button>
            <div class="toggle-auth" onclick="app.auth.toggleView('login')">
                ¬øYa registrado? <span>Acceder</span>
            </div>
        </div>
    </div>

    <div id="dashboard-container" class="glass-panel hidden">
        <header class="dash-header">
            <div class="logo" style="font-size: 1.5rem;">NEXUS <span style="font-size:0.8rem; color:var(--text-muted)">// V.4.2.0</span></div>
            <div style="display:flex; align-items:center; gap:15px;">
                <span id="user-display" style="font-size:0.9rem; color:var(--primary-color)"></span>
                <button class="btn-command" onclick="app.modals.openSettingsModal()" title="Panel de Control">‚öôÔ∏è</button>
            </div>
        </header>

        <main class="main-area">
            <div id="drop-zone" class="drop-zone">
                <div class="scan-line"></div>
                <div style="font-size: 3rem; color: var(--primary-color); margin-bottom: 10px;">‚≠≥</div>
                <h3 id="drop-text">Arrastra archivos al N√∫cleo</h3>
                <p style="color:var(--text-muted); font-size:0.9rem;">Multimedia, C√≥digo, Documentos y Datos</p>
                <input type="file" id="file-input" class="hidden" multiple onchange="app.dashboard.handleFiles(this.files)">
                <button class="btn" style="margin-top:15px;" onclick="document.getElementById('file-input').click()">Explorar Sistema</button>
            </div>
            <h3 style="margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">Archivos en Memoria</h3>
            <div id="file-grid" class="file-grid"></div>
            <button class="btn btn-float btn-icon" onclick="app.modals.openHelp()">?</button>
        </main>
    </div>

    <div id="editor-modal" class="modal-overlay">
        <div class="editor-window glass-panel slide-up">
            <header class="editor-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="file-type-icon">üìÑ</span>
                    <!-- RENAME FEATURE UI -->
                    <div class="filename-wrapper">
                        <input type="text" id="fileNameInput" class="filename-input" spellcheck="false" autocomplete="off">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="btn-ai-analyze" class="btn" style="border-color: var(--warning); color: var(--warning);" onclick="app.ai.analyzeCurrentFile()">‚ú® Analizar</button>
                    <button id="btn-save" class="btn" onclick="app.editor.saveFile()">Descargar</button>
                    <button class="btn btn-icon" onclick="app.modals.closeAll()" style="border-color:var(--danger); color:var(--danger);">‚úï</button>
                </div>
            </header>
            <div class="editor-content">
                <textarea id="code-editor" class="hidden" spellcheck="false" placeholder="Esperando entrada de datos..."></textarea>
                <iframe id="pdf-viewer" class="hidden"></iframe>
                <img id="img-viewer" class="hidden" alt="Preview">
                <video id="video-viewer" class="hidden" controls></video>
                <div id="audio-wrapper" class="hidden">
                    <div class="audio-visualizer">üéµ</div>
                    <audio id="audio-player" controls></audio>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="glass-panel settings-modal slide-up">
            <div class="settings-grid">
                <div class="settings-section">
                    <h5 class="settings-title">Estado de la Cuenta</h5>
                    <div class="user-stats-header">
                        <div class="avatar-circle">OP</div>
                        <div class="stats-info">
                            <label style="color:var(--text-muted); font-size:0.8rem;">ID de Operador</label>
                            <input type="text" id="settings-email-display" class="cyber-input" style="border:none; background:rgba(0,0,0,0.1); padding-left:10px;" readonly>
                            <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                                <span>Almacenamiento Local</span>
                                <span style="color:var(--warning)">15%</span>
                            </div>
                            <div class="storage-bar-bg"><div class="storage-bar-fill"></div></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h5 class="settings-title">Motor Visual (Theme Engine)</h5>
                    <label style="display:block; margin-bottom:10px; color:var(--text-muted); font-size:0.9rem;">Paleta de Color Primaria</label>
                    <div class="theme-cards-container">
                        <div class="theme-card" style="background: linear-gradient(135deg, #002233, #00f3ff);" onclick="app.settings.setTheme('#00f3ff')"><span class="theme-label">CYBER CYAN</span></div>
                        <div class="theme-card" style="background: linear-gradient(135deg, #220033, #ff00ff);" onclick="app.settings.setTheme('#ff00ff')"><span class="theme-label">NEON PURPLE</span></div>
                        <div class="theme-card" style="background: linear-gradient(135deg, #112200, #ccff00);" onclick="app.settings.setTheme('#ccff00')"><span class="theme-label">TOXIC LIME</span></div>
                        <div class="theme-card" style="background: linear-gradient(135deg, #331100, #ff8800);" onclick="app.settings.setTheme('#ff8800')"><span class="theme-label">SOLAR FLARE</span></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px dashed var(--glass-border); padding-bottom:15px;">
                        <label style="color:var(--text-muted); font-size:0.9rem;">Modo Laboratorio (Light Mode)</label>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle" onchange="app.settings.toggleLightMode()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.9rem;">Intensidad de Cristal (Blur)</label>
                    <div class="range-container">
                        <input type="range" min="0" max="30" value="16" oninput="app.settings.setBlur(this.value)">
                    </div>
                </div>

                <div class="settings-section">
                    <h5 class="settings-title">Seguridad Avanzada</h5>
                    <div class="input-group">
                        <label>Contrase√±a Actual</label>
                        <div class="input-wrapper">
                            <span class="input-icon-left">üîí</span>
                            <input type="password" id="pwd-current" class="cyber-input">
                            <span class="input-toggle-right" onclick="app.ui.togglePassword('pwd-current', this)">üëÅÔ∏è</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-group">
                            <label>Nueva Clave</label>
                            <div class="input-wrapper">
                                <span class="input-icon-left">üîë</span>
                                <input type="password" id="pwd-new" class="cyber-input">
                                <span class="input-toggle-right" onclick="app.ui.togglePassword('pwd-new', this)">üëÅÔ∏è</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Confirmar</label>
                            <div class="input-wrapper">
                                <span class="input-icon-left">üîë</span>
                                <input type="password" id="pwd-confirm" class="cyber-input">
                                <span class="input-toggle-right" onclick="app.ui.togglePassword('pwd-confirm', this)">üëÅÔ∏è</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn" style="width:100%" onclick="app.auth.changePassword()">Actualizar Credenciales</button>
                </div>

                <div style="display:flex; gap:15px;">
                    <button class="btn btn-danger" style="flex:1" onclick="app.auth.logout()">CERRAR SESI√ìN</button>
                    <button class="btn" style="flex:1; border-color:var(--text-muted); color:var(--text-muted);" onclick="app.modals.closeAll()">VOLVER</button>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="glass-panel small-modal slide-up">
            <h3 class="modal-title">SOBRE LA APP</h3>
            <p style="margin-bottom:15px; color:var(--text-muted); line-height:1.6;">
                Suite de gesti√≥n de archivos segura, futurista y multimedia.
                Visualizaci√≥n en tiempo real sin descarga previa.
            </p>
            <h4 style="margin-bottom:10px; color:var(--primary-color);">Soporte Extendido:</h4>
            <ul style="list-style:none; margin-bottom:20px; color:var(--text-main);">
                <li>‚Ä¢ <b>Docs:</b> PDF, TXT, MD, CSV, JSON</li>
                <li>‚Ä¢ <b>Code:</b> JS, HTML, CSS, PY, JAVA, SQL, XML</li>
                <li>‚Ä¢ <b>Media:</b> MP4, WEBM, MP3, WAV, JPG, PNG, GIF, WEBP</li>
            </ul>
            <div style="text-align:right;">
                <button class="btn" onclick="app.modals.closeAll()">Entendido</button>
            </div>
        </div>
    </div>

    <div id="ai-chat-modal" class="modal-overlay">
        <div class="glass-panel small-modal chat-modal slide-up">
            <h3 class="modal-title" style="display:flex; justify-content:space-between;">
                NEURAL LINK V1.0 <span>‚ú®</span>
            </h3>
            <div id="chat-history" class="chat-history">
                <div class="chat-msg msg-ai">Inicializando Neural Link... ¬øEn qu√© puedo asistirte, operador?</div>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" class="cyber-input" placeholder="Escribe tu consulta..." onkeypress="if(event.key === 'Enter') app.ai.chat()">
                <button class="btn" onclick="app.ai.chat()">Enviar</button>
            </div>
            <button class="btn" style="margin-top:10px; border-color:var(--text-muted); color:var(--text-muted)" onclick="app.modals.closeAll()">Cerrar Enlace</button>
        </div>
    </div>

    <div id="ai-result-modal" class="modal-overlay">
        <div class="glass-panel small-modal chat-modal slide-up">
            <h3 class="modal-title">AN√ÅLISIS DE C√ìDIGO/TEXTO ‚ú®</h3>
            <div id="ai-analysis-content" class="chat-history" style="font-family: monospace; white-space: pre-wrap;"></div>
            <button class="btn" onclick="app.modals.closeAll()">Cerrar Informe</button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Injected by environment

        const app = {
            state: {
                currentUser: null,
                usersDB: [],
                files: [],
                currentFile: null
            },
            
            init: () => {
                app.bg.init();
                app.settings.load();
                app.dashboard.initListeners();
                app.editor.initListeners(); 
                
                const db = localStorage.getItem('nexus_users_db');
                if (db) {
                    app.state.usersDB = JSON.parse(db);
                } else {
                    app.state.usersDB = [{ email: 'admin@nexus.com', pass: '123' }];
                    localStorage.setItem('nexus_users_db', JSON.stringify(app.state.usersDB));
                }

                const savedUser = localStorage.getItem('nexus_user_session');
                if(savedUser) {
                    app.state.currentUser = savedUser;
                    app.auth.showDashboard();
                }
            },

            ui: {
                notify: (message, type = 'info') => {
                    const container = document.getElementById('toast-container');
                    let icon = '‚Ñπ';
                    let typeClass = 'toast-info';
                    if (type === 'success') { icon = '‚úì'; typeClass = 'toast-success'; } 
                    else if (type === 'error') { icon = '!'; typeClass = 'toast-error'; }

                    const toast = document.createElement('div');
                    toast.className = `cyber-toast ${typeClass}`;
                    toast.innerHTML = `<div class="toast-icon">${icon}</div><div>${message}</div>`;
                    container.appendChild(toast);
                    setTimeout(() => {
                        toast.classList.add('hide');
                        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 400); 
                    }, 4000);
                },
                togglePassword: (id, el) => {
                    const input = document.getElementById(id);
                    if (input.type === 'password') {
                        input.type = 'text'; el.textContent = 'üîí'; el.style.color = 'var(--primary-color)';
                    } else {
                        input.type = 'password'; el.textContent = 'üëÅÔ∏è'; el.style.color = 'var(--text-muted)';
                    }
                }
            },

            ai: {
                callGemini: async (prompt) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok) throw new Error('Error en la red neuronal');
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) { return "Error de conexi√≥n con el n√∫cleo de IA."; }
                },
                openChat: () => {
                    document.getElementById('ai-chat-modal').classList.add('active');
                    setTimeout(() => document.getElementById('chat-input').focus(), 100);
                },
                chat: async () => {
                    const input = document.getElementById('chat-input');
                    const history = document.getElementById('chat-history');
                    const text = input.value.trim();
                    if (!text) return;
                    const userDiv = document.createElement('div'); userDiv.className = 'chat-msg msg-user'; userDiv.textContent = text;
                    history.appendChild(userDiv);
                    input.value = ''; history.scrollTop = history.scrollHeight;
                    const loadingDiv = document.createElement('div'); loadingDiv.className = 'chat-msg ai-loading'; loadingDiv.textContent = "Procesando...";
                    history.appendChild(loadingDiv);
                    const response = await app.ai.callGemini(`Eres Nexus AI. Responde corto y t√©cnico.\n\nUser: ${text}`);
                    history.removeChild(loadingDiv);
                    const aiDiv = document.createElement('div'); aiDiv.className = 'chat-msg msg-ai'; aiDiv.textContent = response;
                    history.appendChild(aiDiv);
                    history.scrollTop = history.scrollHeight;
                },
                analyzeCurrentFile: async () => {
                    const file = app.state.currentFile;
                    if (!file) return;
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf', 'jpg', 'png', 'gif', 'webp', 'mp4', 'webm', 'mp3', 'wav'].includes(ext)) {
                        app.ui.notify("La IA solo analiza texto/c√≥digo.", "error");
                        return;
                    }
                    const editor = document.getElementById('code-editor');
                    const content = editor.value;
                    if (!content.trim()) { app.ui.notify("Archivo vac√≠o.", "error"); return; }
                    document.getElementById('ai-result-modal').classList.add('active');
                    const resultDiv = document.getElementById('ai-analysis-content');
                    resultDiv.textContent = "Analizando...";
                    const response = await app.ai.callGemini(`Analiza esto:\n\n${content.substring(0, 5000)}`);
                    resultDiv.textContent = response;
                }
            },

            utils: {
                formatBytes: (bytes, decimals = 2) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
                },
                validateEmail: (email) => {
                    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return regex.test(email);
                }
            },

            auth: {
                toggleView: (view) => {
                    const loginForm = document.getElementById('login-form');
                    const regForm = document.getElementById('register-form');
                    if (view === 'register') { loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); }
                    else { regForm.classList.add('hidden'); loginForm.classList.remove('hidden'); }
                    document.querySelectorAll('.cyber-input').forEach(i => i.classList.remove('error'));
                },
                checkStrength: (pass) => {
                    const bar = document.getElementById('strength-bar');
                    const text = document.getElementById('strength-text');
                    const btn = document.getElementById('btn-register');
                    let strength = 0;
                    if (pass.length >= 6) strength++;
                    if (pass.length > 9) strength++;
                    if (/[A-Z0-9]/.test(pass)) strength++;
                    let width = 0; let color = 'var(--danger)'; let label = 'D√âBIL';
                    if (pass.length === 0) { width = 0; btn.disabled = true; label = ''; }
                    else if (pass.length < 6) { width = 30; color = 'var(--danger)'; label = 'D√âBIL (Min 6)'; btn.disabled = true; }
                    else if (pass.length >= 6 && pass.length <= 9) { width = 60; color = 'var(--warning)'; label = 'NORMAL'; btn.disabled = false; }
                    else { width = 100; color = 'var(--success)'; label = 'FUERTE'; btn.disabled = false; }
                    bar.style.width = width + '%'; bar.style.backgroundColor = color;
                    text.textContent = label; text.style.color = color;
                },
                register: () => {
                    const emailInput = document.getElementById('reg-email');
                    const passInput = document.getElementById('reg-pass');
                    const email = emailInput.value.trim();
                    const pass = passInput.value;
                    if (!app.utils.validateEmail(email)) { emailInput.classList.add('error'); app.ui.notify('Formato de correo inv√°lido.', 'error'); return; }
                    else { emailInput.classList.remove('error'); }
                    if (pass.length < 6) { passInput.classList.add('error'); app.ui.notify('La contrase√±a es demasiado d√©bil.', 'error'); return; }
                    const exists = app.state.usersDB.find(u => u.email === email);
                    if (exists) { app.ui.notify('El usuario ya existe.', 'error'); return; }
                    const newUser = { email, pass };
                    app.state.usersDB.push(newUser);
                    localStorage.setItem('nexus_users_db', JSON.stringify(app.state.usersDB));
                    app.state.currentUser = email;
                    localStorage.setItem('nexus_user_session', email);
                    app.ui.notify(`Registro exitoso. Acceso concedido, ${email.split('@')[0]}`, 'success');
                    const container = document.getElementById('auth-container');
                    container.style.opacity = '0';
                    container.style.transform = 'scale(0.9)';
                    setTimeout(() => { container.classList.add('hidden'); app.auth.showDashboard(); }, 500);
                    emailInput.value = ''; passInput.value = '';
                },
                login: () => {
                    const emailInput = document.getElementById('login-email');
                    const passInput = document.getElementById('login-pass');
                    const email = emailInput.value.trim();
                    const pass = passInput.value;
                    if (!app.utils.validateEmail(email)) { emailInput.classList.add('error'); app.ui.notify('Formato de correo inv√°lido.', 'error'); return; }
                    else { emailInput.classList.remove('error'); }
                    const user = app.state.usersDB.find(u => u.email === email);
                    if (!user) { app.ui.notify('Usuario no encontrado. Reg√≠strate.', 'error'); return; }
                    if (user.pass !== pass) { app.ui.notify('Contrase√±a incorrecta.', 'error'); passInput.classList.add('error'); return; }
                    else { passInput.classList.remove('error'); }
                    app.state.currentUser = email;
                    localStorage.setItem('nexus_user_session', email);
                    app.ui.notify(`Acceso autorizado. Bienvenido, ${email.split('@')[0]}`, 'success');
                    const container = document.getElementById('auth-container');
                    container.style.opacity = '0';
                    container.style.transform = 'scale(0.9)';
                    setTimeout(() => { container.classList.add('hidden'); app.auth.showDashboard(); }, 500);
                },
                changePassword: () => {
                    const currentPassInput = document.getElementById('pwd-current');
                    const newPassInput = document.getElementById('pwd-new');
                    const confirmPassInput = document.getElementById('pwd-confirm');
                    const currentUserEmail = app.state.currentUser;
                    const userIndex = app.state.usersDB.findIndex(u => u.email === currentUserEmail);
                    if (userIndex === -1) { app.ui.notify('Error de sesi√≥n.', 'error'); return; }
                    const user = app.state.usersDB[userIndex];
                    if (currentPassInput.value !== user.pass) { app.ui.notify('La contrase√±a actual no coincide', 'error'); currentPassInput.value = ''; return; }
                    if (newPassInput.value !== confirmPassInput.value) { app.ui.notify('Las nuevas contrase√±as no son iguales', 'error'); return; }
                    if (newPassInput.value.length < 6) { app.ui.notify('Contrase√±a nueva muy corta', 'error'); return; }
                    app.state.usersDB[userIndex].pass = newPassInput.value;
                    localStorage.setItem('nexus_users_db', JSON.stringify(app.state.usersDB));
                    app.ui.notify('Credenciales actualizadas correctamente', 'success');
                    currentPassInput.value = ''; newPassInput.value = ''; confirmPassInput.value = ''; app.modals.closeAll();
                },
                showDashboard: () => {
                    const dash = document.getElementById('dashboard-container');
                    dash.classList.remove('hidden'); dash.classList.add('slide-up');
                    document.getElementById('user-display').textContent = `OPERADOR: ${app.state.currentUser}`;
                },
                logout: () => { localStorage.removeItem('nexus_user_session'); location.reload(); }
            },

            modals: {
                openSettingsModal: () => { 
                    document.getElementById('settings-modal').classList.add('active'); 
                    if(app.state.currentUser) {
                        document.getElementById('settings-email-display').value = app.state.currentUser;
                        document.querySelector('.avatar-circle').textContent = app.state.currentUser.substring(0,2).toUpperCase();
                    }
                },
                openHelp: () => { document.getElementById('help-modal').classList.add('active'); },
                closeAll: () => {
                    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
                    const video = document.getElementById('video-viewer');
                    const audio = document.getElementById('audio-player');
                    video.pause(); video.src = "";
                    audio.pause(); audio.src = "";
                    document.getElementById('pdf-viewer').src = "";
                }
            },

            dashboard: {
                initListeners: () => {
                    const zone = document.getElementById('drop-zone');
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        zone.addEventListener(eventName, app.dashboard.preventDefaults, false);
                    });
                    zone.addEventListener('dragover', () => zone.classList.add('dragover'));
                    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
                    zone.addEventListener('drop', app.dashboard.handleDrop);
                },
                preventDefaults: (e) => { e.preventDefault(); e.stopPropagation(); },
                handleDrop: (e) => {
                    const zone = document.getElementById('drop-zone');
                    zone.classList.remove('dragover');
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    app.dashboard.handleFiles(files);
                },
                handleFiles: (files) => {
                    const zone = document.getElementById('drop-zone');
                    const dropText = document.getElementById('drop-text');
                    zone.classList.add('scanning');
                    dropText.textContent = "ESCANEANDO DATOS...";
                    setTimeout(() => {
                        zone.classList.remove('scanning');
                        dropText.textContent = "Arrastra archivos al N√∫cleo";
                        ([...files]).forEach(file => {
                            app.state.files.push(file);
                            app.dashboard.renderFile(file);
                            app.ui.notify(`Archivo [${file.name}] cargado al sistema.`, 'success');
                        });
                    }, 1000);
                },
                renderFile: (file) => {
                    const grid = document.getElementById('file-grid');
                    const div = document.createElement('div');
                    div.className = 'file-card glass-panel';
                    let icon = 'üìÑ';
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) icon = 'üìï';
                    else if (['js', 'html', 'css', 'json', 'py', 'java', 'xml', 'sql', 'csv'].includes(ext)) icon = '‚ö°';
                    else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) icon = 'üñºÔ∏è';
                    else if (['mp4', 'webm', 'ogg'].includes(ext)) icon = 'üé¨';
                    else if (['mp3', 'wav'].includes(ext)) icon = 'üéµ';
                    div.innerHTML = `<span class="file-icon">${icon}</span><div class="file-name">${file.name}</div><div style="font-size:0.7rem; color:var(--primary-color); margin-top:5px;">${app.utils.formatBytes(file.size)}</div>`;
                    div.onclick = () => app.editor.open(file);
                    grid.appendChild(div);
                },
                refresh: () => {
                    const grid = document.getElementById('file-grid');
                    grid.innerHTML = '';
                    app.state.files.forEach(file => app.dashboard.renderFile(file));
                }
            },

            editor: {
                initListeners: () => {
                    const textarea = document.getElementById('code-editor');
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Tab') {
                            e.preventDefault();
                            const start = this.selectionStart;
                            const end = this.selectionEnd;
                            this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
                            this.selectionStart = this.selectionEnd = start + 2;
                        }
                    });
                },
                open: (file) => {
                    app.state.currentFile = file;
                    const modal = document.getElementById('editor-modal');
                    const nameInput = document.getElementById('fileNameInput');
                    const btnSave = document.getElementById('btn-save');
                    const btnAnalyze = document.getElementById('btn-ai-analyze');
                    
                    // Name sync
                    nameInput.value = file.name;
                    nameInput.dataset.originalName = file.name;

                    const textEditor = document.getElementById('code-editor');
                    const pdfViewer = document.getElementById('pdf-viewer');
                    const imgViewer = document.getElementById('img-viewer');
                    const videoViewer = document.getElementById('video-viewer');
                    const audioWrapper = document.getElementById('audio-wrapper');
                    const audioPlayer = document.getElementById('audio-player');
                    
                    [textEditor, pdfViewer, imgViewer, videoViewer, audioWrapper].forEach(el => el.classList.add('hidden'));
                    modal.classList.add('active');
                    
                    const ext = file.name.split('.').pop().toLowerCase();
                    const objectUrl = URL.createObjectURL(file);
                    
                    if (ext === 'pdf' || file.type === 'application/pdf') {
                        pdfViewer.src = objectUrl; pdfViewer.classList.remove('hidden'); btnSave.textContent = "Descargar PDF"; btnAnalyze.classList.add('hidden');
                    } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext) || file.type.startsWith('image/')) {
                        imgViewer.src = objectUrl; imgViewer.classList.remove('hidden'); btnSave.textContent = "Descargar Imagen"; btnAnalyze.classList.add('hidden');
                    } else if (['mp4', 'webm', 'ogg'].includes(ext) || file.type.startsWith('video/')) {
                        videoViewer.src = objectUrl; videoViewer.classList.remove('hidden'); btnSave.textContent = "Descargar Video"; btnAnalyze.classList.add('hidden');
                    } else if (['mp3', 'wav', 'mpeg'].includes(ext) || file.type.startsWith('audio/')) {
                        audioPlayer.src = objectUrl; audioWrapper.classList.remove('hidden'); btnSave.textContent = "Descargar Audio"; btnAnalyze.classList.add('hidden');
                    } else {
                        btnSave.textContent = "Guardar Cambios"; btnAnalyze.classList.remove('hidden');
                        const reader = new FileReader(); reader.onload = (e) => { textEditor.value = e.target.result; textEditor.classList.remove('hidden'); }; reader.readAsText(file);
                    }
                },
                saveFile: () => {
                    const file = app.state.currentFile;
                    
                    // 1. Validate & Update Name
                    const nameInput = document.getElementById('fileNameInput');
                    let newName = nameInput.value.trim();
                    const originalName = nameInput.dataset.originalName;

                    if (!newName) {
                        app.ui.notify('El nombre del archivo no puede estar vac√≠o.', 'error');
                        nameInput.value = originalName;
                        return;
                    }

                    // Handle renaming logic (HACK for read-only File objects)
                    if (newName !== originalName) {
                        try {
                            const fileIndex = app.state.files.indexOf(file);
                            if (fileIndex !== -1) {
                                // Create new file with new name but same content/type
                                const newFile = new File([file], newName, { type: file.type });
                                app.state.files[fileIndex] = newFile;
                                app.state.currentFile = newFile;
                                
                                // Update UI
                                app.dashboard.refresh();
                                nameInput.dataset.originalName = newName; // Sync ref
                            }
                        } catch(e) {
                            console.error("Renaming failed", e);
                        }
                    }

                    const currentFile = app.state.currentFile; // Use potentially new file reference
                    const ext = currentFile.name.split('.').pop().toLowerCase();
                    let downloadUrl; 
                    let fileName = currentFile.name; // Use new name

                    // 2. Save Content or Just Download
                    if (!['pdf', 'jpg', 'png', 'gif', 'webp', 'mp4', 'webm', 'mp3', 'wav'].includes(ext) && !currentFile.type.match(/(image|video|audio)/)) {
                        const content = document.getElementById('code-editor').value;
                        const blob = new Blob([content], { type: 'text/plain' });
                        downloadUrl = URL.createObjectURL(blob); 
                        fileName = 'EDITED_' + currentFile.name; // Prefix if edited content, or just use name? 
                        // Prompt said "update property name... use updated name for download". 
                        // Let's use clean name but keeping 'EDITED_' prefix for text edits is safer to avoid overwrite confusion?
                        // Or removing prefix to fully respect the rename? Let's remove prefix to respect user choice.
                        fileName = currentFile.name; 
                        
                        app.ui.notify('Guardando cambios...', 'info');
                    } else {
                        downloadUrl = URL.createObjectURL(currentFile);
                        app.ui.notify(`Preparando descarga...`, 'info');
                    }

                    setTimeout(() => {
                        const element = document.createElement('a'); 
                        element.setAttribute('href', downloadUrl); 
                        element.setAttribute('download', fileName);
                        element.style.display = 'none'; 
                        document.body.appendChild(element); 
                        element.click(); 
                        document.body.removeChild(element);
                        app.ui.notify('Descarga iniciada.', 'success');
                    }, 500);
                }
            },

            settings: {
                setTheme: (color) => {
                    document.documentElement.style.setProperty('--primary-color', color);
                    document.documentElement.style.setProperty('--primary-glow', color + '66');
                    localStorage.setItem('nexus_theme', color);
                    const cards = document.querySelectorAll('.theme-card');
                    cards.forEach(card => card.classList.remove('active'));
                },
                setBlur: (val) => { document.documentElement.style.setProperty('--glass-blur', val + 'px'); },
                toggleLightMode: () => {
                    document.body.classList.toggle('light-mode');
                    const isLight = document.body.classList.contains('light-mode');
                    localStorage.setItem('nexus_light_mode', isLight);
                },
                load: () => {
                    const theme = localStorage.getItem('nexus_theme');
                    if (theme) app.settings.setTheme(theme);
                    const isLight = localStorage.getItem('nexus_light_mode') === 'true';
                    if(isLight) { document.body.classList.add('light-mode'); const toggle = document.getElementById('theme-toggle'); if(toggle) toggle.checked = true; }
                }
            },

            bg: {
                init: () => {
                    const canvas = document.getElementById('particles-js');
                    const ctx = canvas.getContext('2d');
                    let width, height;
                    const particles = [];
                    const resize = () => { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; };
                    window.addEventListener('resize', resize); resize();
                    class Particle {
                        constructor() {
                            this.x = Math.random() * width; this.y = Math.random() * height;
                            this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.size = Math.random() * 2;
                        }
                        update() {
                            this.x += this.vx; this.y += this.vy;
                            if (this.x < 0 || this.x > width) this.vx *= -1; if (this.y < 0 || this.y > height) this.vy *= -1;
                        }
                        draw() {
                            ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                        }
                    }
                    for (let i = 0; i < 50; i++) particles.push(new Particle());
                    const animate = () => {
                        ctx.clearRect(0, 0, width, height);
                        particles.forEach(p => { p.update(); p.draw(); });
                        particles.forEach((p1, i) => {
                            particles.slice(i + 1).forEach(p2 => {
                                const dx = p1.x - p2.x; const dy = p1.y - p2.y; const dist = Math.sqrt(dx*dx + dy*dy);
                                if (dist < 100) { ctx.strokeStyle = `rgba(255,255,255,${0.1 - dist/1000})`; ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                            });
                        });
                        requestAnimationFrame(animate);
                    };
                    animate();
                }
            }
        };

        // Start Application
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
